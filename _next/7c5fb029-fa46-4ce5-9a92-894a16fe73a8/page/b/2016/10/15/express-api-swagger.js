
          window.__NEXT_REGISTER_PAGE('/b/2016/10/15/express-api-swagger', function() {
            var comp = module.exports=webpackJsonp([11],{552:function(e,t,n){e.exports=n(553)},553:function(e,t,n){"use strict";function a(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var l=n(0),r=a(l),s=n(21),o=a(s),i=n(22),u=n(17),c=a(u),d=function(){return r.default.createElement(c.default,{title:"Generating Swagger documentation for an Express API",date:"2016-10-15",langs:["en"]},function(){return r.default.createElement("div",null,r.default.createElement("p",null,"In the process of finishing up an"," ",r.default.createElement("a",{href:"https://expressjs.com/"},"Express")," project, I wanted to leave a nice set of documentation for future users and/or maintainers of the API. I wanted the documentation to live next to the code, and the tooling to generate a nice site from it. Finally I settled for ",r.default.createElement("a",{href:"http://swagger.io/"},"Swagger")," and used a combination of packages to get the job done."),r.default.createElement("p",null,"There were several things I was expecting from the documentation:"),r.default.createElement("p",null,r.default.createElement("ul",null,r.default.createElement("li",null,"To live in comments next to the code, so it would be easier to remember to update it when needed."),r.default.createElement("li",null,"To generate a decent enough site for navigating it."),r.default.createElement("li",null,"To be able to test the API through that generated site."),r.default.createElement("li",null,"To support making authenticated requests."),r.default.createElement("li",null,"Avoid owning the code for the UI."))),r.default.createElement("h2",null,"Parsing the comments"),r.default.createElement("p",null,"Let's begin by being able to extract Swagger-formatted documentation from comments in the code. The"," ",r.default.createElement("a",{href:"https://www.npmjs.com/package/swagger-jsdoc"},r.default.createElement("code",null,"swagger-jsdoc"))," ","project does exactly that and"," ",r.default.createElement("strong",null,"generates a big object containing the description of the whole API"),". The setup is fairly straightforward if we ignore Swagger specifics:"),r.default.createElement(o.default,{language:"js",style:i.vs2015},"\nconst swaggerJSDoc = require('swagger-jsdoc');\n\nconst spec = swaggerJSDoc({\n  swaggerDefinition: {\n    info: {\n      title: 'Project title',\n      version: '1.0.0'\n    },\n    produces: ['application/json'],\n    consumes: ['application/json'],\n    securityDefinitions: {\n      jwt: {\n        type: 'apiKey',\n        name: 'Authorization',\n        in: 'header'\n      }\n    },\n    security: [\n      { jwt: [] }\n    ]\n  },\n  apis: [\n    'lib/routes/*.js'\n  ]\n});\n  "),r.default.createElement("p",null,"The generator function receives an options object with two important properties:"),r.default.createElement("p",null,r.default.createElement("ul",null,r.default.createElement("li",null,r.default.createElement("code",null,"swaggerDefinition")," will include Swagger's global options, which can be found on its"," ",r.default.createElement("a",{href:"http://swagger.io/specification/"},"specification")," ",'under "Schema".'),r.default.createElement("li",null,r.default.createElement("code",null,"apis")," contains an array of paths that"," ",r.default.createElement("code",null,"swagger-jsdoc")," will try to parse."))),r.default.createElement("p",null,"I hadn't used Swagger before starting with this documentation, so I'll write up about some useful properties I've been learning along the way with references to their specs:"),r.default.createElement("p",null,r.default.createElement("ul",null,r.default.createElement("li",null,r.default.createElement("code",null,"info")," contains metadata about the API. Its contents are a Swagger"," ",r.default.createElement("a",{href:"http://swagger.io/specification/#infoObject"},"Info Object"),"."),r.default.createElement("li",null,r.default.createElement("code",null,"produces")," and ",r.default.createElement("code",null,"consumes")," are array of mime types that the API responds with and accepts, respectively. They can be set for each endpoint, but since the API I'm working on uses mostly JSON it was useful to set them as a global default."),r.default.createElement("li",null,r.default.createElement("code",null,"securityDefinitions")," specifies the way the user has to authenticate to use the API."," ",r.default.createElement("strong",null,"The project uses JWT for authentication")," ","(which I talked about in"," ",r.default.createElement("a",{href:"/2016/10/01/express-jwt"},"a previous post"),") so I set it up according to Swagger's"," ",r.default.createElement("a",{href:"http://swagger.io/specification/#securityDefinitionsObject"},"security definition"),". It basically means that the API expects a key on the"," ",r.default.createElement("code",null,"Authorization")," header."),r.default.createElement("li",null,r.default.createElement("code",null,"security"),", similar to ",r.default.createElement("code",null,"produces")," and"," ",r.default.createElement("code",null,"consumes"),", can be set per endpoint - but since most of the API requires authentication, I specify it globally and override it when needed. It's an array of"," ",r.default.createElement("a",{href:"http://swagger.io/specification/#securityRequirementObject"},"security requirements objects")," ","which for this kind of authentication means just listing the required security definitions."))),r.default.createElement("h2",null,"Writing the documentation"),r.default.createElement("p",null,"With that setup, the next step is to write some documentation for the endpoints. ",r.default.createElement("code",null,"swagger-jsdoc")," doesn't expect the comments to be placed anywhere specific, as long as they are somewhere in the files included by the paths defined in the"," ",r.default.createElement("code",null,"apis")," option, so in this case"," ",r.default.createElement("strong",null,"I want each endpoint definition to have its documentation right above it"),". Let's go with a fairly comprehensive example:"),r.default.createElement(o.default,{language:"js",style:i.vs2015},'\n/**\n  * @swagger\n  * /users:\n  *   put:\n  *     summary: Creates a new user\n  *     description:\n  *       "Required roles: `admin`"\n  *     tags:\n  *       - Users\n  *     parameters:\n  *       - name: body\n  *         in: body\n  *         required: true\n  *         schema:\n  *           type: object\n  *           required:\n  *             - username\n  *             - password\n  *           properties:\n  *             username:\n  *               type: string\n  *             password:\n  *               type: password\n  *           example: {\n  *             "username": "someUser",\n  *             "password": "somePassword"\n  *           }\n  *     responses:\n  *       200:\n  *         schema:\n  *           type: object\n  *           properties:\n  *             id:\n  *               type: integer\n  *             username:\n  *               type: string\n  *         examples:\n  *           application/json: {\n  *             "id": 1,\n  *             "username": "someuser"\n  *           }\n  *       409:\n  *         description: When the username is already in use\n  */\nrouter.put(\'/\', restrictToRoles(\'owner\'), createUser);\n  '),r.default.createElement("p",null,"Most of the structure is self-explanatory. The YAML structure"," ",r.default.createElement("strong",null,"begins with the endpoint's route"),", and includes"," ",r.default.createElement("strong",null,"one or several HTTP verbs"),". In this case since I'll document each verb on a separate comment, it will always have one verb. Then follows a short summary of the endpoint's purpose and an optional description. I've used the"," ",r.default.createElement("code",null,"description")," field to document the required roles since Swagger only supports roles (actually scopes) properly when using OAuth authentication. Next we assign ",r.default.createElement("code",null,"tags")," to the endpoint, which will be used to"," ",r.default.createElement("strong",null,"group related endpoints in the UI"),"."),r.default.createElement("p",null,"Then things get a little bit more complex."," ",r.default.createElement("a",{href:"http://swagger.io/specification/#parameterObject"},"Parameter objects")," ","in Swagger include all parameters"," ",r.default.createElement("strong",null,"from query string parameters to headers, passing through form fields, path parameters and request bodies"),". In this case, we expect to receive the data for the new user on a JSON body. Even though there are several fields that our endpoint needs,"," ",r.default.createElement("strong",null,"they're all defined inside the single body parameter's schema"),"."," ",r.default.createElement("a",{href:"http://swagger.io/specification/#schemaObject"},"The schema object")," ","is probably the most complicated part of the Swagger spec that I had to deal with yet, but the basics are simple enough."," ",r.default.createElement("strong",null,"You define"," ",r.default.createElement("a",{href:"http://swagger.io/specification/#dataTypeFormat"},"a type")," ","for it"),", and if it's an object or an array"," ",r.default.createElement("strong",null,"you include a ",r.default.createElement("code",null,"properties")," or ",r.default.createElement("code",null,"items")," ","property respectively"),", describing the shape of its elements. In this case we expect an object with ",r.default.createElement("code",null,"username")," and"," ",r.default.createElement("code",null,"password"),". We could add a ",r.default.createElement("code",null,"description")," ","field for them but they are self explanatory."),r.default.createElement("p",null,r.default.createElement("code",null,"responses")," lists the possible response codes for the endpoint, with an optional ",r.default.createElement("code",null,"schema")," property to describe the response format. With everything defined, eventually our UI will look similar to this:"),r.default.createElement("p",null,r.default.createElement("img",{src:"/static/images/blog/swagger-example.png",alt:"Swagger UI",title:""})),r.default.createElement("p",null,"See that red warning sign to the right? That means that"," ",r.default.createElement("strong",null,"the endpoint is secured")," (because we defined that to be the default) and clicking on it allows us to set the"," ",r.default.createElement("code",null,"Authorization")," header to"," ",r.default.createElement("strong",null,"make authenticated requests"),' by clicking on the "Try it out!" button. Let\'s see how to create that UI now.'),r.default.createElement("h2",null,"Generating the documentation site"),r.default.createElement("p",null,r.default.createElement("a",{href:"https://www.npmjs.com/package/swagger-ui-express"},r.default.createElement("code",null,"swagger-ui-express"))," ","will do just that for us. With a very simple API, given the object with the API definition that ",r.default.createElement("code",null,"swagger-jsdoc")," created, it can be set up on a route and serve that documentation:"),r.default.createElement(o.default,{language:"js",style:i.vs2015},"\nconst swaggerUi = require('swagger-ui-express');\n\n/**\n * Assuming we have a <code>router</code> here and the <code>spec</code>\n * generated by swagger-jsdoc...\n */\n\nrouter.use('/docs', swaggerUi.serve, swaggerUi.setup(spec));\n  "),r.default.createElement("p",null,"And as simple as that,"," ",r.default.createElement("strong",null,"our documentation now lives under the ",r.default.createElement("code",null,"/docs")," ","endpoint"),". All the files for the site are owned by"," ",r.default.createElement("code",null,"swagger-ui-express"),", so maintainers of the project don't have to worry about keeping it updated."),r.default.createElement("p",null,"I did make a little tweak to that configuration above. By default, the generated site will show the URL of an example JSON spec on its input field at the top. While it still works correctly, I set the route up so that it will add a query parameter to my actual JSON spec. For the sake of consistency, I also added an endpoint to serve the raw JSON spec:"),r.default.createElement(o.default,{language:"js",style:i.vs2015},"\n/**\n * Given `spec` and the `router`\n */\nconst swaggerUi = require('swagger-ui-express');\n\nconst docsJsonPath = '/api-docs.json';\nconst swaggerUiHandler = swaggerUi.setup(spec);\n\nrouter.get(docsJsonPath, (req, res) => {\n  res.setHeader('Content-Type', 'application/json');\n  res.send(spec);\n});\n\nrouter.use('/docs', swaggerUi.serve, (req, res, next) => {\n  if (!req.query.url) {\n    res.redirect(<code>/docs?url=http://${req.headers.host}${docsJsonPath}</code>);\n  } else {\n    swaggerUiHandler(req, res, next);\n  }\n});\n  "),r.default.createElement("p",null,"That ",r.default.createElement("code",null,"url")," query parameter makes the page show the given URL at the top instead of the default."," ",r.default.createElement("strong",null,"And that's it!")," The only thing left is to document every endpoint in the API."),r.default.createElement("h2",null,"Alternatives"),r.default.createElement("p",null,"There are two alternatives that I considered throughout the process. The first is ",r.default.createElement("a",{href:"http://apidocjs.com/"},"apiDoc"),", which generates the documentation from JSDoc-looking comments. I decided against it because I had a couple of issues with the generated site and also preferred to use something seemingly more standard like Swagger, but it looks like an interesting project."),r.default.createElement("p",null,"The other is to use"," ",r.default.createElement("a",{href:"https://github.com/apigee-127/swagger-tools"},r.default.createElement("code",null,"swagger-tools")),", a project recommended by ",r.default.createElement("code",null,"swagger-jsdoc"),", to generate the UI based on the spec. While the project works similarly to ",r.default.createElement("code",null,"swagger-ui-express"),", the version of the Swagger UI it comes with is outdated and doesn't support header-based authentication. While ",r.default.createElement("code",null,"swagger-ui-express"),"' version is also a bit outdated, it's new enough to include it."," ",r.default.createElement("code",null,"swagger-tools")," does support defining a custom directory with a different version of Swagger UI, but that would mean checking out the code for the UI in version control and start owning it, which is something I wanted to avoid."),r.default.createElement("h2",null,"Links"),r.default.createElement("ul",null,r.default.createElement("li",null,r.default.createElement("a",{href:"http://swagger.io/specification/"},"Swagger Specification")),r.default.createElement("li",null,r.default.createElement("a",{href:"https://www.npmjs.com/package/swagger-jsdoc"},r.default.createElement("code",null,"swagger-jsdoc"))),r.default.createElement("li",null,r.default.createElement("a",{href:"https://www.npmjs.com/package/swagger-ui-express"},r.default.createElement("code",null,"swagger-ui-express")))))})};t.default=d}},[552]);
            return { page: comp.default }
          })
        