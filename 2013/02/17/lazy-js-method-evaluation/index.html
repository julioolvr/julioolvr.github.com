<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]-->
<html class='no-js'>
  <head>
    <meta charset='utf-8'>
    <meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
    <title>Lazy JS method evaluation | Julio</title>
    <meta content='Blog' name='description'>
    <meta content='width=device-width' name='viewport'>
    <link href='https://plus.google.com/117723231368654711284/posts' rel='author'>
    <meta content='summary' name='twitter:card'>
    <meta content='@julioolvr' name='twitter:site'>
    <meta content='Lazy JS method evaluation' name='twitter:title'>
    <meta content='El otro día, mirando contra mi voluntad el código de CKEditor, me encontré con un patrón para evaluación lazy de los métodos de un objeto JS bastante canchero (y probablemente conocido).&#x000A;' name='twitter:description'>
    <script src="../../../../javascripts/vendor/modernizr-2.6.1.min.js" type="text/javascript"></script>
    <link href="http://fonts.googleapis.com/css?family=Open+Sans|Bree+Serif" rel="stylesheet" type="text/css" />
    <link href="http://fonts.googleapis.com/css?family=Roboto:400,100,300" rel="stylesheet" type="text/css" />
    <link href="../../../../stylesheets/site.css" rel="stylesheet" type="text/css" />
  </head>
  <body>
    <!--[if lt IE 7]> <p class=chromeframe>Your browser is <em>ancient!</em> <a href="http://browsehappy.com/">Upgrade to a different browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to experience this site.</p> <![endif]-->
    <div class='content'>
      <div class='main' role='main'>
        <article class='post'>
          <div class='date'>
            2013/02/17
          </div>
          <h1>
            Lazy JS method evaluation
          </h1>
          <div class='tags'>
            <a href="/tags/javascript/">#javascript</a>
          </div>
          <p>El otro día, mirando contra mi voluntad el código de <a href="https://github.com/ckeditor/ckeditor-dev">CKEditor</a>, me encontré con un patrón para evaluación lazy de los métodos de un objeto JS bastante canchero (y probablemente conocido).</p>
          
          <p>
          Por ejemplo, digamos que un método de un objeto tiene una parte excesivamente costosa, representada convenientemente por una función llamada <code>doSomethingExpensive</code>.</p>
          <pre class="highlight javascript"><code>  <span class="kd">function</span> <span class="nx">doSomethingExpensive</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'expensive!'</span><span class="p">);</span>&#x000A;    <span class="k">return</span> <span class="mi">42</span><span class="p">;</span>&#x000A;  <span class="p">}</span>&#x000A;&#x000A;  <span class="kd">function</span> <span class="nx">doSomethingCheap</span><span class="p">(</span><span class="nx">answer</span><span class="p">)</span> <span class="p">{</span>&#x000A;    <span class="k">return</span> <span class="nx">answer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>&#x000A;  <span class="p">}</span>&#x000A;&#x000A;  <span class="kd">function</span> <span class="nx">objeto</span><span class="p">()</span> <span class="p">{}</span>&#x000A;&#x000A;  <span class="nx">objeto</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">metodo</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="kd">var</span> <span class="nx">expensive</span> <span class="o">=</span> <span class="nx">doSomethingExpensive</span><span class="p">();</span>&#x000A;    <span class="nx">doSomethingCheap</span><span class="p">(</span><span class="nx">expensive</span><span class="p">);</span>&#x000A;  <span class="p">}</span>&#x000A;&#x000A;  <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">objeto</span><span class="p">();</span>&#x000A;  <span class="nx">obj</span><span class="p">.</span><span class="nx">metodo</span><span class="p">();</span> <span class="c1">// logs 'expensive!'</span>&#x000A;  <span class="nx">obj</span><span class="p">.</span><span class="nx">metodo</span><span class="p">();</span> <span class="c1">// logs 'expensive!' again</span>&#x000A;</code></pre>
          
          <p>Bien, con cada llamada a <code>metodo</code> se ejecuta <code>doSomethingExpensive</code>. Si el resultado de esa función varía con cada llamada al método, no hay mucho que hacer. Pero si el resultado puede cachearse, o si es necesario porque el resultado necesita ser compartido entre sucesivas llamadas al método, entonces una primera forma de cambiarlo sería procesarlo cuando se declara el método:</p>
          <pre class="highlight javascript"><code>  <span class="nx">objeto</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">metodo</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="kd">var</span> <span class="nx">expensive</span> <span class="o">=</span> <span class="nx">doSomethingExpensive</span><span class="p">();</span>&#x000A;&#x000A;    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;      <span class="nx">doSomethingCheap</span><span class="p">(</span><span class="nx">expensive</span><span class="p">);</span>&#x000A;    <span class="p">};</span>&#x000A;  <span class="p">})();</span>&#x000A;&#x000A;  <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">objeto</span><span class="p">();</span> <span class="c1">// logs 'expensive!'</span>&#x000A;  <span class="nx">obj</span><span class="p">.</span><span class="nx">metodo</span><span class="p">();</span> <span class="c1">// no loguea nada</span>&#x000A;  <span class="nx">obj</span><span class="p">.</span><span class="nx">metodo</span><span class="p">();</span> <span class="c1">// no loguea nada</span>&#x000A;</code></pre>
          
          <p>La <a href="http://benalman.com/news/2010/11/immediately-invoked-function-expression/">IIFE</a> se ejecuta en el momento de declarar el método, evalúa <code>doSomethingExpensive</code>, almacena el resultado y devuelve una función que usa ese valor almacenado. Esto es un avance, pero presenta la desventaja de que ejecuta <code>doSomethingExpensive</code> incluso si <code>metodo</code> nunca se llama. Dependiendo del caso, esto puede ser importante, ya sea que se vayan a inicializar muchos objetos como para retrasar el tiempo de inicio de la aplicación, o porque el resultado de <code>doSomethingExpensive</code> solamente es significativo en el momento en que se ejecuta <code>metodo</code>, no en el momento en el que se declara. En ese caso, la alternativa, que es la que vi en el código de CKEditor (en particular <a href="https://github.com/ckeditor/ckeditor-dev/blob/master/core/dom/document.js#L237">acá</a> al momento de escribir esto, el método <code>getWindow</code> de <code>document</code>), es que el método haga la evaluación, y luego se reemplace a sí mismo por una copia que use el valor ya calculado:</p>
          <pre class="highlight javascript"><code>  <span class="nx">objeto</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">metodo</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="kd">var</span> <span class="nx">expensive</span> <span class="o">=</span> <span class="nx">doSomethingExpensive</span><span class="p">();</span>&#x000A;    <span class="k">this</span><span class="p">.</span><span class="nx">metodo</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;      <span class="k">return</span> <span class="nx">doSomethingCheap</span><span class="p">(</span><span class="nx">expensive</span><span class="p">);</span>&#x000A;    <span class="p">};</span>&#x000A;    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">metodo</span><span class="p">();</span>&#x000A;  <span class="p">}</span>&#x000A;&#x000A;  <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">objeto</span><span class="p">();</span> <span class="c1">// no loguea nada</span>&#x000A;  <span class="nx">obj</span><span class="p">.</span><span class="nx">metodo</span><span class="p">();</span> <span class="c1">// logs 'expensive!'</span>&#x000A;  <span class="nx">obj</span><span class="p">.</span><span class="nx">metodo</span><span class="p">();</span> <span class="c1">// no loguea nada</span>&#x000A;</code></pre>
          
          <p>Esto combina lo mejor de los dos mundos, no ejecuta <code>doSomethingExpensive</code> si <code>metodo</code> no se ejecuta nunca, y por otro lado si lo hace, lo hace una sola vez y comparte el resultado entre las sucesivas llamadas a <code>metodo</code>. Aprovechando que el valor de retorno de una asignación es el valor asignado, se puede hacer una versión más corta:</p>
          <pre class="highlight javascript"><code>  <span class="nx">objeto</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">metodo</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="kd">var</span> <span class="nx">expensive</span> <span class="o">=</span> <span class="nx">doSomethingExpensive</span><span class="p">();</span>&#x000A;    <span class="k">return</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">metodo</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>&#x000A;      <span class="k">return</span> <span class="nx">doSomethingCheap</span><span class="p">(</span><span class="nx">expensive</span><span class="p">);</span>&#x000A;    <span class="p">})();</span>&#x000A;  <span class="p">}</span>&#x000A;</code></pre>
          <div class='comments'>
            <div id='disqus_thread'></div>
            <script>
              var disqus_shortname = 'julioblog'; // required: replace example with your forum shortname
              
              (function() {
                  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                  dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
              })();
            </script>
            <a class='dsq-brlink' href='http://disqus.com'>
              comments powered by
              <span class='logo-disqus'>Disqus</span>
            </a>
          </div>
        </article>
      </div>
      <section class='sidebar'>
        <a href='/'>
          <img class="sidebar-profile-pic" src="http://www.gravatar.com/avatar/a81ad64d19c864be3c478b761f4b4817?s=300" />
        </a>
        <ul class='sidebar-bio'>
          <li>
            <a href='/'>julio olivera</a>
          </li>
          <li>software developer</li>
          <li>
            <a href='http://github.com/julioolvr' target='blank'>github</a>,
            <a href='http://www.twitter.com/julioolvr' target='blank'>twitter</a>
          </li>
        </ul>
      </section>
    </div>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js" type="text/javascript"></script>
    <script>
      window.jQuery || document.write('<script src="javascripts/vendor/jquery-1.8.0.min.js"><\/script>')
    </script>
    <script src="../../../../javascripts/site.js" type="text/javascript"></script>
    <script>
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-38383863-1']);
      _gaq.push(['_setDomainName', 'joliv.me']);
      _gaq.push(['_trackPageview']);
      
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </body>
</html>
