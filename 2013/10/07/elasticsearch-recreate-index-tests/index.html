<!DOCTYPE html><head><title>Recreate ElasticSearch index for integration testing. | Julio</title><meta charset="utf-8"><link rel="shortcut icon" type="image/png" href="/favicon.png"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/css/highlight-ocean.css"><link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans|Bree+Serif"><link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:400,100,300"><link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Raleway:400,100,300"><script async src="//codepen.io/assets/embed/ei.js"></script></head><body><div class="container"><header><a href="/"><img class="profile-pic" src="http://www.gravatar.com/avatar/a81ad64d19c864be3c478b761f4b4817?s=300"></a><ul class="bio"><li><a href="/">julio olivera</a></li><li>software developer</li><li><a href="http://github.com/julioolvr">github</a>,
<a href="http://www.twitter.com/julioolvr">twitter</a></li></ul></header><main><article class="post"><time datetime="2013-10-07T00:00:00.000Z">2013/10/06</time><h1>Recreate ElasticSearch index for integration testing.</h1><div class="tags"><a href="/tags/elasticsearch">#elasticsearch</a>,
<a href="/tags/tire">#tire</a>,
<a href="/tags/ruby">#ruby</a>,
<a href="/tags/rails">#rails</a></div><p>I fought against this for most of last week so now that I solved it I figured I could share it with the rest of the world (not that I had much fun running tons of Jenkins' builds to see if it was fixed...).</p>
<p>So, we have a Rails app that uses ElasticSearch for a few features. There's a single index that we query, and for integration test purposes we create a fake test index so we can go through the whole stack. We are using <a href="https://github.com/karmi/retire">Tire</a> with its <code>Persistence</code> module, so in our <code>spec_helper.rb</code> (asuming we have a model called <code>Book</code>) we had something along the lines of:</p>
<pre class="hljs"><code>before(<span class="hljs-symbol">:each</span>) <span class="hljs-keyword">do</span>
  Book.index.delete
  Book.create_elasticsearch_index
<span class="hljs-keyword">end</span>
</code></pre>
<p>There was some more unrelated stuff in there (like deleting the index after the whole suite was completed, or using <a href="https://github.com/bblimke/webmock">Webmock</a> to ensure that we are not making any unwanted HTTP requests), the only detail that I want to mention is that you might want to wait for a <a href="https://github.com/karmi/retire/issues/537#issuecomment-11124205">yellow status</a> before each test to avoid &quot;No active shards&quot; errors.</p>
<p>Back to the problem at hand, nothing seems wrong with this, but then we started having random 404 errors because the index was missing during the examples. But it should be there, right? It should be created right after it was deleted.</p>
<p>I enabled debugging on Tire's config, and I found something like the following:</p>
<pre class="hljs"><code><span class="hljs-comment"># 2013-10-04 09:25:05:839 [DELETE] ("test_index")</span>
<span class="hljs-comment">#</span>
curl -X DELETE http://some-server:9200/test_index

<span class="hljs-comment"># 2013-10-04 09:25:05:840 [200]</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># {</span>
<span class="hljs-comment">#   "ok": true,</span>
<span class="hljs-comment">#   "acknowledged": true</span>
<span class="hljs-comment"># }</span>

<span class="hljs-comment"># 2013-10-04 09:25:05:852 [HEAD] ("test_index")</span>
<span class="hljs-comment">#</span>
curl -I <span class="hljs-string">"http://some-server:9200/test_index"</span>

<span class="hljs-comment"># 2013-10-04 09:25:05:852 [200]</span>
</code></pre>
<p>So, right after the <code>DELETE</code> request, there's a <code>HEAD</code> request against the same index, which returns 200.</p>
<p>What.</p>
<p>First of all, the <code>HEAD</code> request comes from Tire doing <a href="http://rubydoc.info/github/karmi/tire/master/Tire/Model/Indexing/ClassMethods#create_elasticsearch_index-instance_method">an existence check before creating the index</a>. Makes sense. But why would it return 200 if the <code>DELETE</code> request that came just before that one returned a 200 ok everything is perfect response?</p>
<p>Well, help comes from <a href="http://stackoverflow.com/questions/19182682/elasticsearch-async-delete-200-just-after-deleting-index-in-rails-app/19224515">the great people at StackOverflow</a>. First comment: turns out <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/modules-http.html">the entire ES HTTP API is asynchronous</a>. So yeah, I get the 200 for the <code>DELETE</code> request but the index wasn't necessarily deleted yet. So, what do we do? Follow the suggestion at the accepted answer for that question: poll ES until we are sure that the index was deleted.</p>
<p>So, in our Tire initializer, I added:</p>
<pre class="hljs"><code>Tire::Index.class_eval <span class="hljs-keyword">do</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">ensure_deleted</span></span>
    <span class="hljs-number">5</span>.times <span class="hljs-keyword">do</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">unless</span> exists?
    <span class="hljs-keyword">end</span>

    raise <span class="hljs-string">"The ElasticSearch index wasn't successfully deleted."</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>And then modified the hooks to look like:</p>
<pre class="hljs"><code>before(<span class="hljs-symbol">:each</span>) <span class="hljs-keyword">do</span>
  Book.index.ensure_deleted
  Book.create_elasticsearch_index
<span class="hljs-keyword">end</span>

after(<span class="hljs-symbol">:each</span>) <span class="hljs-keyword">do</span>
  Book.index.delete
<span class="hljs-keyword">end</span>
</code></pre>
<p>So basically, we check five times to see if the index was deleted. I didn't show the whole log, but in all the failures only one request returned the fake 200 after the <code>DELETE</code>, the next one always returned 404 correctly, so limiting it to 5 tries made sense.</p>
<p>That's it! I hope this can save someone some time and the anger against the world that I went through.</p>
</article></main></div></body>